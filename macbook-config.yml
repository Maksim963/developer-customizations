---
- name: Setup Development Environment
  hosts: localhost
  become: no

  vars:
    brew_packages:
      - docker
      - miniconda
      - rustup-init
      - go
      - opencode
      - ocaml
      - opam
      - terraform
      - zsh-autocomplete
      - awscli
      - dune
      - llvm
      - scmpuff

    cask_apps:
      - { name: "Docker", cask: "docker" }
      - { name: "MiddleClick", cask: "middleclick" }
      - { name: "DBeaver Community Edition", cask: "dbeaver-community" }
      - { name: "Rectangle", cask: "rectangle" }
      - { name: "Raycast", cask: "raycast" }
      - { name: "Anaconda", cask: "anaconda" }
      - { name: "ClickHouse", cask: "clickhouse" }
      - { name: "Ghostty", cask: "ghostty" }
      - { name: "Google Cloud SDK", cask: "google-cloud-sdk" }
      - { name: "MediaInfo", cask: "mediainfo" }
      - { name: "Multipass", cask: "multipass" }
      - { name: "ngrok", cask: "ngrok" }

    ai_tool_casks:
      - claude-code
      - codex
      - codex-app
      - opencode-desktop

    raycast_defaults:
      global_hotkey: "Command-49"
      preferred_window_mode: "default"
      follow_system_appearance: true
      use_hyper_key_icon: false

    macos_defaults:
      dock:
        - { domain: "com.apple.dock", key: "autohide", type: "bool", value: true }
        - { domain: "com.apple.dock", key: "orientation", type: "string", value: "right" }
        - { domain: "com.apple.dock", key: "tilesize", type: "int", value: 38 }
        - { domain: "com.apple.dock", key: "minimize-to-application", type: "bool", value: true }
      finder:
        - { domain: "com.apple.finder", key: "AppleShowAllFiles", type: "bool", value: true }
        - { domain: "NSGlobalDomain", key: "AppleShowAllExtensions", type: "bool", value: true }
        - { domain: "com.apple.finder", key: "FXPreferredViewStyle", type: "string", value: "Nlsv" }
      trackpad_mouse:
        - { domain: "com.apple.AppleMultitouchTrackpad", key: "Clicking", type: "bool", value: false }
        - { domain: "com.apple.driver.AppleBluetoothMultitouch.trackpad", key: "Clicking", type: "bool", value: false }
        - { domain: "com.apple.AppleMultitouchTrackpad", key: "TrackpadRightClick", type: "bool", value: true }
        - { domain: "com.apple.driver.AppleBluetoothMultitouch.trackpad", key: "TrackpadRightClick", type: "bool", value: true }
        - { domain: "NSGlobalDomain", key: "com.apple.mouse.scaling", type: "float", value: 0.875 }
        - { domain: "NSGlobalDomain", key: "com.apple.swipescrolldirection", type: "bool", value: false }
        - { domain: "com.apple.AppleMultitouchTrackpad", key: "TrackpadThreeFingerDrag", type: "bool", value: false }
        - { domain: "com.apple.driver.AppleBluetoothMultitouch.trackpad", key: "TrackpadThreeFingerDrag", type: "bool", value: false }
      keyboard:
        - { domain: "NSGlobalDomain", key: "NSAutomaticSpellingCorrectionEnabled", type: "bool", value: false }
        - { domain: "NSGlobalDomain", key: "NSAutomaticCapitalizationEnabled", type: "bool", value: false }
        - { domain: "NSGlobalDomain", key: "NSAutomaticPeriodSubstitutionEnabled", type: "bool", value: true }

    cursor_extensions:
      - 1yib.rust-bundle
      - 4ops.terraform
      - alefragnani.bookmarks
      - anthropic.claude-code
      - anysphere.cursorpyright
      - bradlc.vscode-tailwindcss
      - bungcip.better-toml
      - cstuder.gitlab-ci-validator
      - dart-code.dart-code
      - dart-code.flutter
      - dbaeumer.vscode-eslint
      - donjayamanne.python-environment-manager
      - donjayamanne.python-extension-pack
      - dustypomerleau.rust-syntax
      - emeryberger.scalene
      - esbenp.prettier-vscode
      - github.copilot
      - github.copilot-chat
      - github.vscode-github-actions
      - gitlab.gitlab-workflow
      - golang.go
      - google.gemini-cli-vscode-ide-companion
      - hashicorp.terraform
      - inferrinizzard.prettier-sql-vscode
      - james-yu.latex-workshop
      - jasonn-porch.gitlab-mr
      - jcbuisson.vue
      - juanblanco.solidity
      - kevinrose.vsc-python-indent
      - mgmcdermott.vscode-language-babel
      - mitaki28.vscode-clang
      - modular-mojotools.vscode-mojo
      - ms-azuretools.vscode-docker
      - ms-kubernetes-tools.vscode-kubernetes-tools
      - ms-playwright.playwright
      - ms-python.black-formatter
      - ms-python.debugpy
      - ms-python.python
      - ms-toolsai.jupyter
      - ms-toolsai.jupyter-keymap
      - ms-toolsai.jupyter-renderers
      - ms-toolsai.vscode-jupyter-cell-tags
      - ms-toolsai.vscode-jupyter-slideshow
      - ms-vscode-remote.remote-containers
      - ms-vscode-remote.remote-ssh
      - ms-vscode-remote.remote-ssh-edit
      - ms-vscode-remote.remote-wsl
      - ms-vscode-remote.vscode-remote-extensionpack
      - ms-vscode.cmake-tools
      - ms-vscode.cpptools
      - ms-vscode.cpptools-extension-pack
      - ms-vscode.cpptools-themes
      - ms-vscode.remote-explorer
      - ms-vscode.remote-server
      - njpwerner.autodocstring
      - nrw.vscode-protolint-nrw
      - ocamllabs.ocaml-platform
      - panicbit.cargo
      - peterj.proto
      - prisma.prisma
      - redhat.ansible
      - redhat.vscode-yaml
      - rust-lang.rust-analyzer
      - rvest.vs-code-prettier-eslint
      - serayuzgur.crates
      - shd101wyy.markdown-preview-enhanced
      - stagewise.stagewise-vscode-extension
      - streetsidesoftware.code-spell-checker
      - svelte.svelte-vscode
      - tamasfe.even-better-toml
      - tim-koehler.helm-intellisense
      - tobermory.es6-string-html
      - vadimcn.vscode-lldb
      - vintharas.learn-vim
      - visualstudioexptteam.intellicode-api-usage-examples
      - visualstudioexptteam.vscodeintellicode
      - vue.volar
      - waderyan.gitblame
      - wholroyd.jinja
      - william-voyek.vscode-nginx
      - xaver.clang-format
      - ziglang.vscode-zig
      - zxh404.vscode-proto3

  tasks:
    - name: Ensure .zshrc exists
      ansible.builtin.file:
        path: ~/.zshrc
        state: touch

    - name: Append custom configurations to .zshrc
      ansible.builtin.blockinfile:
        path: ~/.zshrc
        block: "{{ lookup('file', 'config/zshrc-appends.sh') }}"
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Custom commands"
        insertafter: EOF

    - name: Install Homebrew packages
      community.general.homebrew:
        name: "{{ brew_packages }}"
        state: present

    - name: Check for existing cask applications
      ansible.builtin.stat:
        path: "/Applications/{{ item.name }}.app"
      register: app_check
      loop: "{{ cask_apps }}"

    - name: Install Homebrew cask packages
      community.general.homebrew_cask:
        name: "{{ item.item.cask }}"
        state: present
        greedy: false
      when: not item.stat.exists
      loop: "{{ app_check.results }}"
      register: cask_install_result

    - name: Install AI tool casks
      community.general.homebrew_cask:
        name: "{{ item }}"
        state: present
        greedy: false
      loop: "{{ ai_tool_casks }}"

    - name: Configure Raycast global hotkey
      community.general.osx_defaults:
        domain: com.raycast.macos
        key: raycastGlobalHotkey
        type: string
        value: "{{ raycast_defaults.global_hotkey }}"

    - name: Configure Raycast preferred window mode
      community.general.osx_defaults:
        domain: com.raycast.macos
        key: raycastPreferredWindowMode
        type: string
        value: "{{ raycast_defaults.preferred_window_mode }}"

    - name: Configure Raycast follow system appearance
      community.general.osx_defaults:
        domain: com.raycast.macos
        key: raycastShouldFollowSystemAppearance
        type: bool
        value: "{{ raycast_defaults.follow_system_appearance }}"

    - name: Configure Raycast hyper key icon preference
      community.general.osx_defaults:
        domain: com.raycast.macos
        key: useHyperKeyIcon
        type: bool
        value: "{{ raycast_defaults.use_hyper_key_icon }}"

    ##################################################
    #              macOS UI Settings                 #
    ##################################################

    - name: Apply Dock defaults
      community.general.osx_defaults:
        domain: "{{ item.domain }}"
        key: "{{ item.key }}"
        type: "{{ item.type }}"
        value: "{{ item.value }}"
      loop: "{{ macos_defaults.dock }}"

    - name: Apply Finder defaults
      community.general.osx_defaults:
        domain: "{{ item.domain }}"
        key: "{{ item.key }}"
        type: "{{ item.type }}"
        value: "{{ item.value }}"
      loop: "{{ macos_defaults.finder }}"

    - name: Apply trackpad and mouse defaults
      community.general.osx_defaults:
        domain: "{{ item.domain }}"
        key: "{{ item.key }}"
        type: "{{ item.type }}"
        value: "{{ item.value }}"
      loop: "{{ macos_defaults.trackpad_mouse }}"

    - name: Apply keyboard defaults
      community.general.osx_defaults:
        domain: "{{ item.domain }}"
        key: "{{ item.key }}"
        type: "{{ item.type }}"
        value: "{{ item.value }}"
      loop: "{{ macos_defaults.keyboard }}"

    - name: Disable Spotlight keyboard shortcuts
      ansible.builtin.shell: defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add {{ item.id }} "{{ item.value }}"
      args:
        executable: /bin/zsh
      loop:
        - { id: "64", value: "{ enabled = 0; value = { parameters = (65535, 49, 1048576); type = standard; }; }" }
        - { id: "65", value: "{ enabled = 0; value = { parameters = (65535, 49, 1572864); type = standard; }; }" }
      changed_when: false

    - name: Restart Dock to apply settings
      ansible.builtin.command: killall Dock
      changed_when: false
      failed_when: false

    - name: Restart Finder to apply settings
      ansible.builtin.command: killall Finder
      changed_when: false
      failed_when: false

    - name: Restart SystemUIServer to apply keyboard shortcut changes
      ansible.builtin.command: killall SystemUIServer
      changed_when: false
      failed_when: false

    ##################################################
    #            Languages Setup                     #
    ##################################################

    - name: Initialize rustup
      ansible.builtin.command: rustup-init -y --no-modify-path
      args:
        creates: ~/.cargo/bin/rustc

    - name: Add Rust to PATH in .zshrc
      ansible.builtin.lineinfile:
        path: ~/.zshrc
        line: "export PATH=$PATH:$HOME/.cargo/bin"
        state: present

    - name: Add OCaml opam to .zshrc
      ansible.builtin.lineinfile:
        path: ~/.zshrc
        line: "eval $(opam env)"
        state: present

    ##################################################
    #            Cloud Tools Setup                   #
    ##################################################

    - name: Add Google Cloud SDK to .zshrc
      ansible.builtin.blockinfile:
        path: ~/.zshrc
        block: |
          # The next line updates PATH for the Google Cloud SDK.
          if [ -f '/usr/local/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/path.zsh.inc' ]; then . '/usr/local/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/path.zsh.inc'; fi

          # The next line enables shell command completion for gcloud.
          if [ -f '/usr/local/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/completion.zsh.inc' ]; then . '/usr/local/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/completion.zsh.inc'; fi
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Google Cloud SDK"
        state: present

    - name: Add AWS CLI shell completion to .zshrc
      ansible.builtin.lineinfile:
        path: ~/.zshrc
        line: 'complete -C "/usr/local/bin/aws_completer" aws'
        state: present

    ##################################################
    #            Productivity tools                  #
    ##################################################

    - name: Configure middleclick for tap to click
      ansible.builtin.command: defaults write com.matthewlunsford.MiddleClick TapToClick -bool true
      register: middleclick_config
      changed_when: middleclick_config.rc != 0

    - name: Add MiddleClick to login items
      ansible.builtin.shell: |
        osascript -e 'tell application "System Events" to make login item at end with properties {path:"/Applications/MiddleClick.app", hidden:false}'
      register: add_login_item
      changed_when: add_login_item.rc != 0
      failed_when: add_login_item.rc != 0 and "already exists" not in add_login_item.stderr

    - name: Add Rectangle to login items
      ansible.builtin.shell: |
        osascript -e 'tell application "System Events" to make login item at end with properties {path:"/Applications/Rectangle.app", hidden:false}'
      register: add_rectangle_login_item
      changed_when: add_rectangle_login_item.rc != 0
      failed_when: add_rectangle_login_item.rc != 0 and "already exists" not in add_rectangle_login_item.stderr

    ##################################################
    #                Cursor IDE Setup                #
    ##################################################

    - name: Check if Cursor is installed
      ansible.builtin.command: cursor -v
      register: cursor_version
      ignore_errors: yes
      changed_when: false

    - name: Install Cursor if not present
      community.general.homebrew_cask:
        name: cursor
        state: present
      when: cursor_version.rc != 0

    - name: Get list of installed Cursor extensions
      ansible.builtin.command: cursor --list-extensions
      register: installed_extensions
      changed_when: false

    - name: Install Cursor extensions
      ansible.builtin.command: cursor --install-extension {{ item }}
      loop: "{{ cursor_extensions }}"
      when: item not in installed_extensions.stdout_lines
      ignore_errors: yes

    - name: Ensure Cursor settings directory exists
      ansible.builtin.file:
        path: "~/Library/Application Support/Cursor/User"
        state: directory
        mode: "0755"

    - name: Check if custom settings.json exists
      ansible.builtin.stat:
        path: "config/cursor-settings.json"
      register: custom_settings

    - name: Copy custom settings.json to Cursor config directory
      ansible.builtin.copy:
        src: "config/cursor-settings.json"
        dest: "~/Library/Application Support/Cursor/User/settings.json"
        mode: "0644"
      when: custom_settings.stat.exists
